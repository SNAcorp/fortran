{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h2>Dashboard</h2>
<p>Current modifier version: {{ modifier_version }}</p>

{% if request.query_params.get('message') %}
<div class="alert alert-success mt-3" role="alert">
    {{ request.query_params.get('message') }}
</div>
{% endif %}

{% if request.query_params.get('error') %}
<div class="alert alert-danger mt-3" role="alert">
    {{ request.query_params.get('error') }}
</div>
{% endif %}

<ul class="list-group">
    {% for file in files %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <h5>{{ file.title }}</h5>
            <p>{{ file.description }}</p>
            <p>Uploaded: {{ file.upload_date.strftime('%Y-%m-%d') }}</p>
            <p>Modifier version: {{ file.modifier_version.id }}</p>
        </div>
        <div>
            <a href="/download/original/{{ file.id }}" class="btn btn-primary btn-sm">Download Original</a>
            <a href="/download/modified/{{ file.id }}" class="btn btn-secondary btn-sm">Download Modified</a>
            {% if file.modifier_version.id != modifier_version %}
            <form action="/remodify/{{ file.id }}" method="post" class="remodify-form" style="display:inline;">
                <button type="submit" class="btn btn-warning btn-sm">Remodify with Latest Modifier</button>
            </form>
            {% endif %}
        </div>
    </li>
    {% endfor %}
</ul>

<script>
document.querySelectorAll('.remodify-form').forEach(form => {
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const response = await fetch(form.action, {
            method: form.method,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        const result = await response.json();
        if (response.status === 200) {
            window.location.href = "/dashboard?message=" + encodeURIComponent(result.message);
        } else {
            window.location.href = "/dashboard?error=" + encodeURIComponent(result.message);
        }
    });
});
</script>

{% endblock %}
